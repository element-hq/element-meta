name: Forward epic field value into tracked issues

on:
  issues:
    types: [edited]

jobs:
  forward_epic_field_value:
    name: Forward epic field value into tracked issues
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            projectId = "PVT_kwDOAM0swc4AA19d";
            fieldId = "PVTSSF_lADOAM0swc4ALoFYzgJAimw";
            fieldName = "Epic";
            
            // Query all the things via GraphQL

            const query = `query ($owner: String!, $repo: String!, $issueNumber: Int!, $fieldName: String!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issueNumber) {
                  projectItems(first: 100) {
                    edges {
                      node {
                        id
                        fieldValueByName(name: $fieldName) {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            id
                            name
                            field {
                              ... on ProjectV2SingleSelectField {
                                id
                              }
                            }
                          }
                        }
                        project {
                          id
                        }
                      }
                    }
                  }
                  trackedIssues(first: 100) {
                    edges {
                      node {
                        projectItems(first: 100) {
                          edges {
                            node {
                              id
                              project {
                                id
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }`;

            const parameters = {
              owner: github.repository.split("/")[0],
              repo: github.repository.split("/")[1],
              issueNumber: github.event.issue.number,
              fieldName
            };
            
            const result = await github.graphql(query, parameters);
            
            // Check project membership and extract field value

            const projectItems = result.data.repository.issue.projectItems.edges;
            
            if (!projectItems) {
              console.log("Issue is not part of any projects");
              return;
            }
            
            let fieldValueId = null;
            let fieldValueName = null;

            for (const item of projectItems) {
              if (item.node.project.id == projectId && item.node.fieldValueByName && item.node.fieldValueByName.field.id == fieldId) {
                fieldValueId = item.node.fieldValueByName.id;
                fieldValueName = item.node.fieldValueByName.name;
                break;
              }
            }
            
            if (!fieldValueId || !fieldValueName) {
              console.log("Issue is not part of the correct project or does not have the field value set");
              return;
            }
            
            // Apply field value to tracked issues
            
            const trackedIssues = result.data.repository.issue.trackedIssues.edges;
            
            if (!trackedIssues) {
              console.log("Issue has no tracked issues");
              return;
            }
            
            for (const issue of trackedIssues) {
              const projectItems = issue.node.projectItems.edges;
              
              if (!projectItems) {
                continue; // TODO: Add tracked issue to project?
              }
              
              for (const item of projectItems) {
                if (item.node.project.id == projectId) {
                  const mutation = `mutation($projectId: String!, $itemId: String!, $fieldId: String!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { 
                          singleSelectOptionId: $optionId        
                        }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }`;
                  
                  const parameters = {
                    projectId,
                    itemId: item.node.id,
                    fieldId,
                    optionId: fieldValueId
                  };
                  
                  const result = await github.graphql(mutation, parameters);
                  console.log(JSON.stringify(result));
                  
                  break;
                }
              }
            }
